<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>ObraTrack ‚Äî Mapa de Demandas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- ‚úÖ Gr√°ficos interativos -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

  <!-- ‚úÖ CSS separado -->
  <link rel="stylesheet" href="obratrack-mapa-v4.css">
</head>

<body>
<header>
  <div class="brand">
    <div class="logo">OT</div>
    <div>
      <div class="brand-text-title">ObraTrack</div>
      <div class="brand-text-sub">Mapa de demandas ‚Äî S√£o Jos√© de Ribamar / MA</div>
    </div>
  </div>
  <div class="pill-status" id="pillResumo">‚Äì</div>
</header>

<main>
  <section class="top-grid">
    <div class="kpi">
      <div class="kpi-label">Demandas totais</div>
      <div class="kpi-value" id="kpiTotal">‚Äì</div>
      <div class="kpi-foot">Linhas da planilha</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Com coordenadas</div>
      <div class="kpi-value" id="kpiGeo">‚Äì</div>
      <div class="kpi-foot">Pontos plotados</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Regi√µes</div>
      <div class="kpi-value" id="kpiRegioes">‚Äì</div>
      <div class="kpi-foot">Conjunto √∫nico</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Bairros</div>
      <div class="kpi-value" id="kpiBairros">‚Äì</div>
      <div class="kpi-foot">Conjunto √∫nico</div>
    </div>
  </section>

  <section class="layout">
    <!-- ESQUERDA: MAPA -->
    <section class="card-pane">
      <div class="pane-header">
        <div>
          <div class="pane-title">Mapa</div>
          <div class="pane-sub">Selecione uma demanda e use ‚Äúüìå Definir coordenada‚Äù.</div>
        </div>
        <div class="actions">
          <button class="btn" id="btnModoMarcar">üìå Definir coordenada</button>
          <button class="btn" id="btnRemoverCoord">üóëÔ∏è Remover coord</button>
          <button class="btn" id="btnExportar">‚¨áÔ∏è Exportar coords-manual.js</button>
        </div>
      </div>
      <div id="map"></div>
    </section>

    <!-- DIREITA: GR√ÅFICOS + LISTA -->
    <div class="right-col">
      <!-- GR√ÅFICOS -->
      <section class="card-pane" style="min-height:320px;">
        <div class="pane-header">
          <div>
            <div class="pane-title">Gr√°ficos (Power BI)</div>
            <div class="pane-sub">Interativos ‚Ä¢ Clique em Regi√£o/Bairro para filtrar.</div>
          </div>
          <div class="pill-status" id="pillCharts">Aguardando dados‚Ä¶</div>
        </div>

        <div class="hint">Dica: use os filtros abaixo da lista ‚Äî os gr√°ficos acompanham em tempo real.</div>

        <div class="charts-body">
          <div class="chart-card half">
            <div class="chart-title">
              <span>Demandas por Regi√£o</span>
              <span class="chart-sub">clique para filtrar</span>
            </div>
            <div class="chart" id="chartRegiao"></div>
          </div>

          <div class="chart-card half">
            <div class="chart-title">
              <span>Top Bairros</span>
              <span class="chart-sub">clique para filtrar</span>
            </div>
            <div class="chart" id="chartBairro"></div>
          </div>

          <div class="chart-card">
            <div class="chart-title">
              <span>Distribui√ß√£o por Servi√ßo</span>
              <span class="chart-sub">vis√£o geral</span>
            </div>
            <div class="chart" id="chartServico"></div>
          </div>
        </div>
      </section>

      <!-- LISTA -->
      <section class="card-pane">
        <div class="pane-header">
          <div>
            <div class="pane-title">Lista de demandas</div>
            <div class="pane-sub">Clique em uma linha para focar no mapa.</div>
          </div>
          <div class="pill-status" id="pillSel">Nenhuma selecionada</div>
        </div>

        <div class="filter-row">
          <div>
            Regi√£o:
            <select id="filterRegiao">
              <option value="">Todas</option>
            </select>
          </div>
          <div>
            Bairro:
            <input id="filterBairro" placeholder="Ex.: Vila S√£o Luis" />
          </div>
          <div>
            Logradouro:
            <input id="filterLogradouro" placeholder="Ex.: Rua S√£o Jos√©" />
          </div>
        </div>

        <div class="list-body">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Regi√£o / Bairro</th>
                <th>Logradouro</th>
                <th>Servi√ßo</th>
                <th>Geo</th>
              </tr>
            </thead>
            <tbody id="tbodyDemandas"></tbody>
          </table>
        </div>
      </section>
    </div>
  </section>
</main>

<!-- ‚úÖ ORDEM CERTA: primeiro dados, depois app -->
<script src="demandas.js"></script>
<script src="obratrack-mapa-manual-v4.js"></script>

<!-- ‚úÖ Script dos gr√°ficos (ECharts) -->
<script>
(function(){
  const $ = (id) => document.getElementById(id);

  let chReg, chBai, chServ;

  function norm(s){ return (s ?? '').toString().trim(); }
  function lower(s){ return norm(s).toLowerCase(); }

  function normalizeServico(s){
    const t = norm(s);
    if(!t) return '‚Äî';
    const first = t.split(',')[0].trim();
    return first || '‚Äî';
  }

  function groupCount(arr, getKey){
    const m = new Map();
    for(const o of arr){
      const k = getKey(o);
      m.set(k, (m.get(k) || 0) + 1);
    }
    return m;
  }

  function getUIFilters(){
    return {
      regiao: norm($('filterRegiao')?.value),
      bairro: lower($('filterBairro')?.value),
      logradouro: lower($('filterLogradouro')?.value),
    };
  }

  function applyUIFilters(base){
    const f = getUIFilters();
    return base.filter(d => {
      const okRegiao = !f.regiao || norm(d.regiao) === f.regiao;
      const okBairro = !f.bairro || lower(d.bairro).includes(f.bairro);
      const okLogra  = !f.logradouro || lower(d.logradouro).includes(f.logradouro);
      return okRegiao && okBairro && okLogra;
    });
  }

  function textColor(){
    return getComputedStyle(document.body).color || '#fff';
  }

  function ensureCharts(){
    if(!window.echarts) return false;
    if(!$('chartRegiao') || !$('chartBairro') || !$('chartServico')) return false;

    if(!chReg)  chReg  = echarts.init($('chartRegiao'));
    if(!chBai)  chBai  = echarts.init($('chartBairro'));
    if(!chServ) chServ = echarts.init($('chartServico'));
    return true;
  }

  function shortLabel(v, max=12){
    const s = norm(v);
    if(!s) return '‚Äî';
    return s.length > max ? (s.slice(0, max) + '‚Ä¶') : s;
  }

  function updateCharts(){
    if(!Array.isArray(window.DEMANDAS)){
      $('pillCharts').textContent = 'Sem DEMANDAS';
      return;
    }
    if(!ensureCharts()){
      $('pillCharts').textContent = 'Charts indispon√≠veis';
      return;
    }

    const base = window.DEMANDAS;
    const data = applyUIFilters(base);
    $('pillCharts').textContent = `${data.length} itens (filtrados)`;

    const tc = textColor();

    // Regi√£o
    const reg = groupCount(data, d => norm(d.regiao) || '‚Äî');
    const regData = [...reg.entries()].sort((a,b)=>b[1]-a[1]);
    chReg.setOption({
      backgroundColor:'transparent',
      textStyle:{ color: tc },
      tooltip:{ trigger:'axis', axisPointer:{ type:'shadow' } },
      grid:{ left: 90, right: 14, top: 12, bottom: 18, containLabel:true },
      xAxis:{ type:'value' },
      yAxis:{ type:'category', data: regData.map(x=>x[0]) },
      series:[{ type:'bar', data: regData.map(x=>x[1]), barMaxWidth: 18 }],
      toolbox:{ show:false }
    }, true);

    // Bairros (Top 20)
    const bai = groupCount(data, d => norm(d.bairro) || '‚Äî');
    const baiData = [...bai.entries()].sort((a,b)=>b[1]-a[1]).slice(0, 20);
    chBai.setOption({
      backgroundColor:'transparent',
      textStyle:{ color: tc },
      tooltip:{
        trigger:'axis',
        axisPointer:{ type:'shadow' },
        formatter: (p) => {
          const item = Array.isArray(p) ? p[0] : p;
          if(!item) return '';
          return `${item.name}<br/>${item.value} demandas`;
        }
      },
      grid:{ left: 40, right: 14, top: 16, bottom: 86, containLabel:true },
      xAxis:{
        type:'category',
        data: baiData.map(x=>x[0]),
        axisLabel:{
          rotate: 25,
          interval: 0,
          hideOverlap: true,
          formatter: (v) => shortLabel(v, 14)
        }
      },
      yAxis:{ type:'value' },
      dataZoom:[
        { type:'inside', filterMode:'filter' },
        { type:'slider', bottom: 10, height: 18, showDetail:false, showDataShadow:false, filterMode:'filter' }
      ],
      series:[{ type:'bar', data: baiData.map(x=>x[1]), barMaxWidth: 22 }],
      toolbox:{ show:false }
    }, true);

    // Servi√ßos (Donut)
    const serv = groupCount(data, d => normalizeServico(d.servico));
    const servData = [...serv.entries()]
      .sort((a,b)=>b[1]-a[1])
      .map(([name,value])=>({name,value}));

    chServ.setOption({
      backgroundColor:'transparent',
      textStyle:{ color: tc },
      tooltip:{ trigger:'item', formatter: (p)=> `${p.name}<br/>${p.value} (${p.percent}%)` },
      legend:{
        top: 6,
        left: 10,
        right: 10,
        type:'scroll',
        textStyle:{ color: tc },
        pageIconSize: 10
      },
      series:[{
        type:'pie',
        radius:['38%','62%'],
        center:['50%','58%'],
        avoidLabelOverlap:true,
        label:{
          color: tc,
          fontSize: 11,
          formatter: (p)=> shortLabel(p.name, 22)
        },
        labelLine:{ length:10, length2:8 },
        data: servData
      }],
      toolbox:{ show:false }
    }, true);

    // garante resize depois do setOption (ajuda a n√£o cortar quando o grid muda)
    setTimeout(() => {
      chReg?.resize();
      chBai?.resize();
      chServ?.resize();
    }, 0);
  }

  // Clique nos gr√°ficos -> seta filtros existentes
  function bindClicks(){
    if(!chReg || !chBai) return;

    chReg.off('click');
    chReg.on('click', (p) => {
      const sel = $('filterRegiao');
      if(!sel) return;
      sel.value = p.name === '‚Äî' ? '' : p.name;
      sel.dispatchEvent(new Event('change', { bubbles:true }));
      updateCharts();
    });

    chBai.off('click');
    chBai.on('click', (p) => {
      const inp = $('filterBairro');
      if(!inp) return;
      inp.value = p.name === '‚Äî' ? '' : p.name;
      inp.dispatchEvent(new Event('input', { bubbles:true }));
      updateCharts();
    });
  }

  function bindFilterWatch(){
    ['filterRegiao','filterBairro','filterLogradouro'].forEach(id=>{
      const el = $(id);
      if(!el) return;
      el.addEventListener('change', updateCharts);
      el.addEventListener('input', updateCharts);
    });
  }

  // ‚úÖ resize quando o container muda (responsivo de verdade)
  function bindResizeObserver(){
    if(!('ResizeObserver' in window)) return;
    const ids = ['chartRegiao','chartBairro','chartServico'];
    const ro = new ResizeObserver(() => {
      chReg?.resize();
      chBai?.resize();
      chServ?.resize();
    });
    ids.forEach(id => {
      const el = $(id);
      if(el) ro.observe(el);
    });
  }

  window.addEventListener('resize', () => {
    chReg?.resize();
    chBai?.resize();
    chServ?.resize();
  });

  window.addEventListener('load', () => {
    bindFilterWatch();
    updateCharts();
    setTimeout(() => { ensureCharts(); bindClicks(); bindResizeObserver(); }, 80);
    setTimeout(() => { updateCharts(); ensureCharts(); bindClicks(); }, 400);
  });
})();
</script>

</body>
</html>
