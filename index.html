<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>ObraTrack ‚Äî Mapa de Demandas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- ‚úÖ Gr√°ficos interativos -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

  <!-- ‚úÖ CSS separado -->
  <link rel="stylesheet" href="obratrack-mapa-v4.css">
</head>

<body>
<header>
  <div class="brand">
    <div class="logo">OT</div>
    <div>
      <div class="brand-text-title">ObraTrack</div>
      <div class="brand-text-sub">Mapa de demandas ‚Äî S√£o Jos√© de Ribamar / MA</div>
    </div>
  </div>
  <div class="pill-status" id="pillResumo">‚Äì</div>
</header>

<main>
  <section class="top-grid">
    <div class="kpi">
      <div class="kpi-label">Demandas totais</div>
      <div class="kpi-value" id="kpiTotal">‚Äì</div>
      <div class="kpi-foot">Linhas da planilha</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Com coordenadas</div>
      <div class="kpi-value" id="kpiGeo">‚Äì</div>
      <div class="kpi-foot">Pontos plotados</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Regi√µes</div>
      <div class="kpi-value" id="kpiRegioes">‚Äì</div>
      <div class="kpi-foot">Conjunto √∫nico</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Bairros</div>
      <div class="kpi-value" id="kpiBairros">‚Äì</div>
      <div class="kpi-foot">Conjunto √∫nico</div>
    </div>
  </section>

  <section class="layout">
    <!-- ESQUERDA: MAPA -->
    <section class="card-pane">
      <div class="pane-header">
        <div>
          <div class="pane-title">Mapa</div>
          <div class="pane-sub">Selecione uma demanda e use ‚Äúüìå Definir coordenada‚Äù.</div>
        </div>
        <div class="actions">
          <button class="btn" id="btnModoMarcar">üìå Definir coordenada</button>
          <button class="btn" id="btnRemoverCoord">üóëÔ∏è Remover coord</button>
          <button class="btn" id="btnExportar">‚¨áÔ∏è Exportar coords-manual.js</button>
        </div>
      </div>
      <div id="map"></div>
    </section>

    <!-- DIREITA: GR√ÅFICOS + LISTA -->
    <div class="right-col">
      <!-- GR√ÅFICOS -->
      <section class="card-pane" style="min-height:320px;">
        <div class="pane-header">
          <div>
            <div class="pane-title">Gr√°ficos (Power BI)</div>
            <div class="pane-sub">Interativos ‚Ä¢ Clique em Regi√£o/Bairro para filtrar.</div>
          </div>
          <div class="pill-status" id="pillCharts">Aguardando dados‚Ä¶</div>
        </div>

        <div class="hint">Dica: use os filtros abaixo da lista ‚Äî os gr√°ficos acompanham em tempo real.</div>

        <div class="charts-body">
          <div class="chart-card half">
            <div class="chart-title">
              <span>Demandas por Regi√£o</span>
              <span class="chart-sub">clique para filtrar</span>
            </div>
            <div class="chart" id="chartRegiao"></div>
          </div>

          <div class="chart-card half">
            <div class="chart-title">
              <span>Top Bairros</span>
              <span class="chart-sub">clique para filtrar</span>
            </div>
            <div class="chart" id="chartBairro"></div>
          </div>

          <div class="chart-card">
            <div class="chart-title">
              <span>Distribui√ß√£o por Servi√ßo</span>
              <span class="chart-sub">vis√£o geral</span>
            </div>
            <div class="chart" id="chartServico"></div>
          </div>
        </div>
      </section>

      <!-- LISTA -->
      <section class="card-pane">
        <div class="pane-header">
          <div>
            <div class="pane-title">Lista de demandas</div>
            <div class="pane-sub">Clique em uma linha para focar no mapa.</div>
          </div>
          <div class="pill-status" id="pillSel">Nenhuma selecionada</div>
        </div>

        <div class="filter-row">
          <div>
            Regi√£o:
            <select id="filterRegiao">
              <option value="">Todas</option>
            </select>
          </div>
          <div>
            Bairro:
            <input id="filterBairro" placeholder="Ex.: Vila S√£o Luis" />
          </div>
          <div>
            Logradouro:
            <input id="filterLogradouro" placeholder="Ex.: Rua S√£o Jos√©" />
          </div>
        </div>

        <div class="list-body">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Regi√£o / Bairro</th>
                <th>Logradouro</th>
                <th>Servi√ßo</th>
                <th>Geo</th>
              </tr>
            </thead>
            <tbody id="tbodyDemandas"></tbody>
          </table>
        </div>
      </section>
    </div>
  </section>
</main>

<!-- ‚úÖ ORDEM CERTA: primeiro dados, depois app -->
<script src="demandas.js"></script>
<script src="obratrack-mapa-manual-v4.js"></script>

<!-- ‚úÖ MODO SAT√âLITE (Leaflet Layers Control) -->
<script>
(function(){
  try{
    // OBS: "map" √© um binding global (const) criado no seu JS do mapa
    if (typeof map === 'undefined' || !window.L) return;

    // Remove o tile padr√£o que o JS adiciona (OSM), pra n√£o ficar duplicado
    const toRemove = [];
    map.eachLayer((layer) => {
      if (layer && (layer instanceof L.TileLayer)) toRemove.push(layer);
    });
    toRemove.forEach((l) => map.removeLayer(l));

    // Base layers
    const baseMapa = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    });

    const baseSatelite = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      {
        maxZoom: 19,
        attribution: 'Tiles &copy; Esri'
      }
    );

    // Come√ßa no "Mapa"
    baseMapa.addTo(map);

    // Controle
    const collapsed = window.matchMedia && window.matchMedia('(max-width: 720px)').matches;
    L.control.layers(
      { 'Mapa': baseMapa, 'Sat√©lite': baseSatelite },
      null,
      { position: 'topright', collapsed }
    ).addTo(map);

  } catch (e) {
    console.warn('Falha ao ativar Sat√©lite:', e);
  }
})();
</script>

<!-- ‚úÖ Script dos gr√°ficos (ECharts) -->
<script>
(function(){
  const $ = (id) => document.getElementById(id);

  let chReg, chBai, chServ;

  function norm(s){ return (s ?? '').toString().trim(); }
  function lower(s){ return norm(s).toLowerCase(); }

  function normalizeServico(s){
    const t = norm(s);
    if(!t) return '‚Äî';
    const first = t.split(',')[0].trim();
    return first || '‚Äî';
  }

  function groupCount(arr, getKey){
    const m = new Map();
    for(const o of arr){
      const k = getKey(o);
      m.set(k, (m.get(k) || 0) + 1);
    }
    return m;
  }

  function getUIFilters(){
    return {
      regiao: norm($('filterRegiao')?.value),
      bairro: lower($('filterBairro')?.value),
      logradouro: lower($('filterLogradouro')?.value),
    };
  }

  function applyUIFilters(base){
    const f = getUIFilters();
    return base.filter(d => {
      const okRegiao = !f.regiao || norm(d.regiao) === f.regiao;
      const okBairro = !f.bairro || lower(d.bairro).includes(f.bairro);
      const okLogra  = !f.logradouro || lower(d.logradouro).includes(f.logradouro);
      return okRegiao && okBairro && okLogra;
    });
  }

  function textColor(){
    return getComputedStyle(document.body).color || '#fff';
  }

  function ensureCharts(){
    if(!window.echarts) return false;
    if(!$('chartRegiao') || !$('chartBairro') || !$('chartServico')) return false;

    if(!chReg)  chReg  = echarts.init($('chartRegiao'));
    if(!chBai)  chBai  = echarts.init($('chartBairro'));
    if(!chServ) chServ = echarts.init($('chartServico'));
    return true;
  }

  function shortLabel(s, max=22){
    const t = norm(s);
    if(t.length <= max) return t;
    return t.slice(0, Math.max(0, max-1)) + '‚Ä¶';
  }

  function updateCharts(){
    if(!Array.isArray(window.DEMANDAS)){
      $('pillCharts').textContent = 'Sem DEMANDAS';
      return;
    }
    if(!ensureCharts()){
      $('pillCharts').textContent = 'Charts indispon√≠veis';
      return;
    }

    const base = window.DEMANDAS;
    const data = applyUIFilters(base);
    $('pillCharts').textContent = `${data.length} itens (filtrados)`;

    const tc = textColor();

    // Regi√£o
    const reg = groupCount(data, d => norm(d.regiao) || '‚Äî');
    const regData = [...reg.entries()].sort((a,b)=>b[1]-a[1]);
    chReg.setOption({
      backgroundColor:'transparent',
      textStyle:{ color: tc },
      tooltip:{ trigger:'axis', axisPointer:{ type:'shadow' } },
      grid:{ left: 90, right: 14, top: 12, bottom: 10 },
      xAxis:{ type:'value' },
      yAxis:{ type:'category', data: regData.map(x=>x[0]) },
      series:[{ type:'bar', data: regData.map(x=>x[1]), barMaxWidth: 18 }],
      toolbox:{ show:false }
    }, true);

    // Bairros (Top 20)
    const bai = groupCount(data, d => norm(d.bairro) || '‚Äî');
    const baiData = [...bai.entries()].sort((a,b)=>b[1]-a[1]).slice(0, 20);
    chBai.setOption({
      backgroundColor:'transparent',
      textStyle:{ color: tc },
      tooltip:{ trigger:'axis', axisPointer:{ type:'shadow' } },
      grid:{ left: 44, right: 14, top: 16, bottom: 44 },
      xAxis:{
        type:'category',
        data: baiData.map(x=>x[0]),
        axisLabel:{
          rotate: 30,
          formatter:(v)=> shortLabel(v, 14)
        }
      },
      yAxis:{ type:'value' },
      dataZoom:[{ type:'inside' }, { type:'slider', bottom: 6, height: 12, showDetail:false }],
      series:[{ type:'bar', data: baiData.map(x=>x[1]), barMaxWidth: 22 }],
      toolbox:{ show:false }
    }, true);

    // Distribui√ß√£o por Pavimenta√ß√£o (m)
    const BLOQUETE_M = {
      10: 90, 11: 250,
      52: 140, 55: 140,
      67: 400, 68: 500, 69: 250, 70: 250, 71: 200,
      77: 150, 78: 240, 79: 270, 80: 100, 81: 70,
      83: 170, 84: 180, 85: 350
    };
    const CONCRETO_M = { 1: 350 };
    const ASFALTICA_OVERRIDE_M = { 50: 600, 51: 500 };

    function num(v){
      if(v == null) return 0;
      if(typeof v === 'number') return Number.isFinite(v) ? v : 0;
      const s = String(v).replace(/\s/g,'').replace(/\./g,'').replace(',', '.');
      const n = parseFloat(s);
      return Number.isFinite(n) ? n : 0;
    }
    function fmtM(v){
      const n = Math.round(v);
      return n.toLocaleString('pt-BR') + ' m';
    }
    function fmtKm(v){
      return (v/1000).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' km';
    }

    let totalM = 0, asfM = 0, concM = 0, bloqM = 0, naoInfM = 0;

    for(const d of data){
      const item = Number(d.item);
      const t = num(d.extensao_total_m);
      const conc = num(d.ext_concreto_m ?? CONCRETO_M[item] ?? 0);
      const bloq = num(d.ext_bloquete_m ?? BLOQUETE_M[item] ?? 0);

      let asf = 0;
      if(d.ext_asfaltica_m != null) asf = num(d.ext_asfaltica_m);
      else if(ASFALTICA_OVERRIDE_M[item] != null) asf = num(ASFALTICA_OVERRIDE_M[item]);
      else if(bloq > 0 || conc > 0) asf = 0;
      else asf = t;

      const resto = Math.max(0, t - (asf + conc + bloq));

      totalM += t; asfM += asf; concM += conc; bloqM += bloq; naoInfM += resto;
    }

    const pieData = [
      { name:'Asf√°ltica', value: Math.round(asfM) },
      { name:'Concreto',  value: Math.round(concM) },
      { name:'Bloquete',  value: Math.round(bloqM) },
      { name:'N√£o informado', value: Math.round(naoInfM) }
    ].filter(x => x.value > 0);

    chServ.setOption({
      backgroundColor:'transparent',
      textStyle:{ color: tc },
      tooltip:{
        trigger:'item',
        formatter:(p)=>{
          const v = Number(p.value) || 0;
          return `${p.name}<br/>${fmtM(v)} ‚Ä¢ ${fmtKm(v)}<br/>${p.percent}% do total`;
        }
      },
      legend:{
        top: 6,
        left: 10,
        right: 10,
        type:'scroll',
        textStyle:{ color: tc },
        formatter:(name)=> name
      },
      graphic: [{
        type: 'text',
        left: 'center',
        top: '58%',
        style: {
          text: `${fmtKm(totalM)}\nTotal`,
          fill: tc,
          font: '700 12px Inter, system-ui, sans-serif',
          textAlign: 'center'
        }
      }],
      series:[{
        type:'pie',
        radius:['40%','70%'],
        center:['50%','60%'],
        avoidLabelOverlap:true,
        label:{
          color: tc,
          fontSize: 11,
          formatter:(p)=> `${p.name}: ${fmtKm(p.value)}`
        },
        labelLine:{ length:10, length2:8 },
        data: pieData
      }],
      toolbox:{ show:false }
    }, true);
  }

  function bindClicks(){
    if(!chReg || !chBai) return;

    chReg.off('click');
    chReg.on('click', (p) => {
      const sel = $('filterRegiao');
      if(!sel) return;
      sel.value = p.name === '‚Äî' ? '' : p.name;
      sel.dispatchEvent(new Event('change', { bubbles:true }));
      updateCharts();
    });

    chBai.off('click');
    chBai.on('click', (p) => {
      const inp = $('filterBairro');
      if(!inp) return;
      inp.value = p.name === '‚Äî' ? '' : p.name;
      inp.dispatchEvent(new Event('input', { bubbles:true }));
      updateCharts();
    });
  }

  function bindFilterWatch(){
    ['filterRegiao','filterBairro','filterLogradouro'].forEach(id=>{
      const el = $(id);
      if(!el) return;
      el.addEventListener('change', updateCharts);
      el.addEventListener('input', updateCharts);
    });
  }

  window.addEventListener('resize', () => {
    chReg?.resize();
    chBai?.resize();
    chServ?.resize();
  });

  window.addEventListener('load', () => {
    bindFilterWatch();
    updateCharts();
    setTimeout(() => { ensureCharts(); bindClicks(); }, 80);
    setTimeout(() => { updateCharts(); ensureCharts(); bindClicks(); }, 400);
  });
})();
</script>

</body>
</html>
