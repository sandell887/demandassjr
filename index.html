<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>ObraTrack ‚Äî Mapa de Demandas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- ‚úÖ Gr√°ficos interativos -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

  <!-- ‚úÖ CSS separado -->
  <link rel="stylesheet" href="obratrack-mapa-v4.css">
</head>

<body>
<header>
  <div class="brand">
    <div class="logo">OT</div>
    <div>
      <div class="brand-text-title">ObraTrack</div>
      <div class="brand-text-sub">Mapa de demandas ‚Äî S√£o Jos√© de Ribamar / MA</div>
    </div>
  </div>
  <div class="pill-status" id="pillResumo">‚Äì</div>
</header>

<main>
  <section class="top-grid">
    <div class="kpi">
      <div class="kpi-label">Demandas totais</div>
      <div class="kpi-value" id="kpiTotal">‚Äì</div>
      <div class="kpi-foot">Linhas da planilha</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Com coordenadas</div>
      <div class="kpi-value" id="kpiGeo">‚Äì</div>
      <div class="kpi-foot">Pontos plotados</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Regi√µes</div>
      <div class="kpi-value" id="kpiRegioes">‚Äì</div>
      <div class="kpi-foot">Conjunto √∫nico</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Bairros</div>
      <div class="kpi-value" id="kpiBairros">‚Äì</div>
      <div class="kpi-foot">Conjunto √∫nico</div>
    </div>
  </section>

  <section class="layout">
    <!-- ESQUERDA: MAPA -->
    <section class="card-pane">
      <div class="pane-header">
        <div>
          <div class="pane-title">Mapa</div>
          <div class="pane-sub">Selecione uma demanda e use ‚Äúüìå Definir coordenada‚Äù.</div>
        </div>
        <div class="actions">
          <button class="btn" id="btnModoMarcar">üìå Definir coordenada</button>
          <button class="btn" id="btnRemoverCoord">üóëÔ∏è Remover coord</button>
          <button class="btn" id="btnExportar">‚¨áÔ∏è Exportar coords-manual.js</button>
          <button class="btn" id="btnCentralizar">üéØ Centralizar SJR</button>
        </div>
      </div>
      <div id="map"></div>
    </section>

    <!-- DIREITA: GR√ÅFICOS + LISTA -->
    <div class="right-col">
      <!-- GR√ÅFICOS -->
      <section class="card-pane" style="min-height:320px;">
        <div class="pane-header">
          <div>
            <div class="pane-title">Gr√°ficos (Power BI)</div>
            <div class="pane-sub">Interativos ‚Ä¢ Clique em Regi√£o/Bairro para filtrar.</div>
          </div>
          <div class="pill-status" id="pillCharts">Aguardando dados‚Ä¶</div>
        </div>

        <div class="hint">Dica: use os filtros abaixo da lista ‚Äî os gr√°ficos acompanham em tempo real.</div>

        <div class="charts-body">
          <div class="chart-card half">
            <div class="chart-title">
              <span>Demandas por Regi√£o</span>
              <span class="chart-sub">clique para filtrar</span>
            </div>
            <div class="chart" id="chartRegiao"></div>
          </div>

          <div class="chart-card half">
            <div class="chart-title">
              <span>Top Bairros</span>
              <span class="chart-sub">clique para filtrar</span>
            </div>
            <div class="chart" id="chartBairro"></div>
          </div>

          <div class="chart-card">
            <div class="chart-title">
              <span>Distribui√ß√£o por Servi√ßo</span>
              <span class="chart-sub">vis√£o geral</span>
            </div>
            <div class="chart" id="chartServico"></div>
          </div>
        </div>
      </section>

      <!-- LISTA -->
      <section class="card-pane">
        <div class="pane-header">
          <div>
            <div class="pane-title">Lista de demandas</div>
            <div class="pane-sub">Clique em uma linha para focar no mapa.</div>
          </div>
          <div class="pill-status" id="pillSel">Nenhuma selecionada</div>
        </div>

        <div class="filter-row">
          <div>
            Regi√£o:
            <select id="filterRegiao">
              <option value="">Todas</option>
            </select>
          </div>
          <div>
            Bairro:
            <input id="filterBairro" placeholder="Ex.: Vila S√£o Luis" />
          </div>
          <div>
            Logradouro:
            <input id="filterLogradouro" placeholder="Ex.: Rua S√£o Jos√©" />
          </div>
        </div>

        <div class="list-body">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Regi√£o / Bairro</th>
                <th>Logradouro</th>
                <th>Servi√ßo</th>
                <th>Geo</th>
              </tr>
            </thead>
            <tbody id="tbodyDemandas"></tbody>
          </table>
        </div>
      </section>
    </div>
  </section>
</main>

<!-- ‚úÖ ORDEM CERTA: primeiro dados, depois app -->
<script src="demandas.js"></script>
<script src="obratrack-mapa-manual-v4.js"></script>

<!-- ‚úÖ MODO SAT√âLITE (Leaflet Layers Control) -->
<script>
(function(){
  try{
    if (typeof map === 'undefined' || !window.L) return;

    // Remove tile layers j√° adicionadas pelo JS (pra n√£o duplicar)
    const toRemove = [];
    map.eachLayer((layer) => {
      if (layer && (layer instanceof L.TileLayer)) toRemove.push(layer);
    });
    toRemove.forEach((l) => map.removeLayer(l));

    const baseMapa = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    });

    const baseSatelite = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      { maxZoom: 19, attribution: 'Tiles &copy; Esri' }
    );

    baseMapa.addTo(map);

    const collapsed = window.matchMedia && window.matchMedia('(max-width: 720px)').matches;
    L.control.layers(
      { 'Mapa': baseMapa, 'Sat√©lite': baseSatelite },
      null,
      { position: 'topright', collapsed }
    ).addTo(map);

  } catch (e) {
    console.warn('Falha ao ativar Sat√©lite:', e);
  }
})();
</script>

<!-- ‚úÖ Centralizar SJR -->
<script>
(function(){
  const btn = document.getElementById('btnCentralizar');
  if(!btn) return;

  btn.addEventListener('click', () => {
    try{
      if (typeof map === 'undefined') return;
      // usa o centro do seu JS (SJ_RIBAMAR_CENTER) se existir, sen√£o um fallback
      const c = (typeof SJ_RIBAMAR_CENTER !== 'undefined' && Array.isArray(SJ_RIBAMAR_CENTER))
        ? SJ_RIBAMAR_CENTER
        : [-2.55, -44.07];
      map.flyTo(c, 12, { animate:true, duration:0.8 });
    }catch(e){
      console.warn('Centralizar falhou:', e);
    }
  });
})();
</script>

<!-- ‚úÖ Script dos gr√°ficos (ECharts) -->
<script>
(function(){
  const $ = (id) => document.getElementById(id);

  let chReg, chBai, chServ;

  function norm(s){ return (s ?? '').toString().trim(); }
  function lower(s){ return norm(s).toLowerCase(); }

  function groupCount(arr, getKey){
    const m = new Map();
    for(const o of arr){
      const k = getKey(o);
      m.set(k, (m.get(k) || 0) + 1);
    }
    return m;
  }

  function getUIFilters(){
    return {
      regiao: norm($('filterRegiao')?.value),
      bairro: lower($('filterBairro')?.value),
      logradouro: lower($('filterLogradouro')?.value),
    };
  }

  function applyUIFilters(base){
    const f = getUIFilters();
    return base.filter(d => {
      const okRegiao = !f.regiao || norm(d.regiao) === f.regiao;
      const okBairro = !f.bairro || lower(d.bairro).includes(f.bairro);
      const okLogra  = !f.logradouro || lower(d.logradouro).includes(f.logradouro);
      return okRegiao && okBairro && okLogra;
    });
  }

  function textColor(){
    return getComputedStyle(document.body).color || '#fff';
  }

  function ensureCharts(){
    if(!window.echarts) return false;
    if(!$('chartRegiao') || !$('chartBairro') || !$('chartServico')) return false;

    if(!chReg)  chReg  = echarts.init($('chartRegiao'));
    if(!chBai)  chBai  = echarts.init($('chartBairro'));
    if(!chServ) chServ = echarts.init($('chartServico'));
    return true;
  }

  function shortLabel(s, max=22){
    const t = norm(s);
    if(t.length <= max) return t;
    return t.slice(0, Math.max(0, max-1)) + '‚Ä¶';
  }

  function updateCharts(){
    if(!Array.isArray(window.DEMANDAS)){
      $('pillCharts').textContent = 'Sem DEMANDAS';
      return;
    }
    if(!ensureCharts()){
      $('pillCharts').textContent = 'Charts indispon√≠veis';
      return;
    }

    const base = window.DEMANDAS;

    // ‚úÖ filtros da UI
    let data = applyUIFilters(base);

    // ‚úÖ foco por demanda (quando clicar no mapa/lista)
    const focus = window.__obratChartsFocusItem;
    if(focus != null && focus !== ''){
      const fnum = Number(focus);
      data = data.filter(d => Number(d.item) === fnum);
      $('pillCharts').textContent = `${data.length} item (foco #${fnum})`;
    } else {
      $('pillCharts').textContent = `${data.length} itens (filtrados)`;
    }

    const tc = textColor();

    // Regi√£o
    const reg = groupCount(data, d => norm(d.regiao) || '‚Äî');
    const regData = [...reg.entries()].sort((a,b)=>b[1]-a[1]);
    chReg.setOption({
      backgroundColor:'transparent',
      textStyle:{ color: tc },
      tooltip:{ trigger:'axis', axisPointer:{ type:'shadow' } },
      grid:{ left: 90, right: 14, top: 12, bottom: 10 },
      xAxis:{ type:'value' },
      yAxis:{ type:'category', data: regData.map(x=>x[0]) },
      series:[{ type:'bar', data: regData.map(x=>x[1]), barMaxWidth: 18 }],
      toolbox:{ show:false }
    }, true);

    // Bairros (Top 20)
    const bai = groupCount(data, d => norm(d.bairro) || '‚Äî');
    const baiData = [...bai.entries()].sort((a,b)=>b[1]-a[1]).slice(0, 20);
    chBai.setOption({
      backgroundColor:'transparent',
      textStyle:{ color: tc },
      tooltip:{ trigger:'axis', axisPointer:{ type:'shadow' } },
      grid:{ left: 44, right: 14, top: 16, bottom: 44 },
      xAxis:{
        type:'category',
        data: baiData.map(x=>x[0]),
        axisLabel:{ rotate: 30, formatter:(v)=> shortLabel(v, 14) }
      },
      yAxis:{ type:'value' },
      dataZoom:[{ type:'inside' }, { type:'slider', bottom: 6, height: 12, showDetail:false }],
      series:[{ type:'bar', data: baiData.map(x=>x[1]), barMaxWidth: 22 }],
      toolbox:{ show:false }
    }, true);

    // ‚úÖ Distribui√ß√£o por Servi√ßo (usa o texto REAL do campo "servico")
    function num(v){
      if(v == null) return 0;
      if(typeof v === 'number') return Number.isFinite(v) ? v : 0;
      const s = String(v).replace(/\s/g,'').replace(/\./g,'').replace(',', '.');
      const n = parseFloat(s);
      return Number.isFinite(n) ? n : 0;
    }
    function fmtM(v){
      const n = Math.round(v);
      return n.toLocaleString('pt-BR') + ' m';
    }
    function fmtKm(v){
      return (v/1000).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' km';
    }

    function keyText(v){
      return (v ?? '')
        .toString()
        .trim()
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g,''); // remove acentos
    }

    function tipoServico(d){
      const s = keyText(d?.servico);
      if(!s) return 'N√£o informado';

      if (s.includes('bloquete')) return 'Bloquete';
      if (s.includes('concreto')) return 'Concreto';

      // asfalto / recape / pavimenta√ß√£o (inclui varia√ß√µes/typos tipo "paviment√ßao/pavimentcao")
      if (s.includes('asfalt') || s.includes('recape') || s.includes('pavimentac')) return 'Asf√°ltica';

      return 'N√£o informado';
    }

    let totalM = 0, asfM = 0, concM = 0, bloqM = 0, naoInfM = 0;

    for(const d of data){
      const t = num(d.extensao_total_m);
      const tipo = tipoServico(d);

      totalM += t;

      if (tipo === 'Asf√°ltica') asfM += t;
      else if (tipo === 'Concreto') concM += t;
      else if (tipo === 'Bloquete') bloqM += t;
      else naoInfM += t;
    }

    let pieData = [
      { name:'Asf√°ltica', value: Math.round(asfM) },
      { name:'Concreto',  value: Math.round(concM) },
      { name:'Bloquete',  value: Math.round(bloqM) },
      { name:'N√£o informado', value: Math.round(naoInfM) }
    ].filter(x => x.value > 0);

    // se tudo for 0, evita gr√°fico vazio
    if (pieData.length === 0) {
      pieData = [{ name: 'N√£o informado', value: 1 }];
      totalM = 0;
    }

    chServ.setOption({
      backgroundColor:'transparent',
      textStyle:{ color: tc },
      tooltip:{
        trigger:'item',
        formatter:(p)=>{
          const v = Number(p.value) || 0;
          return `${p.name}<br/>${fmtM(v)} ‚Ä¢ ${fmtKm(v)}<br/>${p.percent}% do total`;
        }
      },
      legend:{ top: 6, left: 10, right: 10, type:'scroll', textStyle:{ color: tc } },
      graphic: [{
        type: 'text',
        left: 'center',
        top: '58%',
        style: {
          text: `${fmtKm(totalM)}\nTotal`,
          fill: tc,
          font: '700 12px Inter, system-ui, sans-serif',
          textAlign: 'center'
        }
      }],
      series:[{
        type:'pie',
        radius:['40%','70%'],
        center:['50%','60%'],
        label:{ color: tc, fontSize: 11, formatter:(p)=> `${p.name}: ${fmtKm(p.value)}` },
        labelLine:{ length:10, length2:8 },
        data: pieData
      }],
      toolbox:{ show:false }
    }, true);
  }

  function bindClicks(){
    if(!chReg || !chBai) return;

    chReg.off('click');
    chReg.on('click', (p) => {
      const sel = $('filterRegiao');
      if(!sel) return;
      sel.value = p.name === '‚Äî' ? '' : p.name;
      window.__obratChartsFocusItem = null;
      sel.dispatchEvent(new Event('change', { bubbles:true }));
      updateCharts();
    });

    chBai.off('click');
    chBai.on('click', (p) => {
      const inp = $('filterBairro');
      if(!inp) return;
      inp.value = p.name === '‚Äî' ? '' : p.name;
      window.__obratChartsFocusItem = null;
      inp.dispatchEvent(new Event('input', { bubbles:true }));
      updateCharts();
    });
  }

  function bindFilterWatch(){
    ['filterRegiao','filterBairro','filterLogradouro'].forEach(id=>{
      const el = $(id);
      if(!el) return;
      el.addEventListener('change', () => { window.__obratChartsFocusItem = null; updateCharts(); });
      el.addEventListener('input',  () => { window.__obratChartsFocusItem = null; updateCharts(); });
    });
  }

  // ‚úÖ API global p/ mapa/lista focar uma demanda
  window.__obratChartsFocusItem = null;
  window.__obratChartsSetFocus = (item) => { window.__obratChartsFocusItem = (item==null?null:Number(item)); updateCharts(); };
  window.__obratChartsClearFocus = () => { window.__obratChartsFocusItem = null; updateCharts(); };
  window.__obratChartsUpdate = updateCharts;

  window.addEventListener('resize', () => {
    chReg?.resize(); chBai?.resize(); chServ?.resize();
  });

  window.addEventListener('load', () => {
    bindFilterWatch();
    updateCharts();
    setTimeout(() => { ensureCharts(); bindClicks(); }, 80);
    setTimeout(() => { updateCharts(); ensureCharts(); bindClicks(); }, 400);
  });
})();
</script>

<!-- ‚úÖ PATCH: filtro de Regi√£o tamb√©m filtra os MARCADORES do mapa (Vilas/Sede/Limitrofe/etc) -->
<script>
(function(){
  const fr = document.getElementById('filterRegiao');
  const fb = document.getElementById('filterBairro');
  const fl = document.getElementById('filterLogradouro');
  const kpiGeo = document.getElementById('kpiGeo');
  const pillResumo = document.getElementById('pillResumo');
  const pillSel = document.getElementById('pillSel');

  function norm(s){ return (s ?? '').toString().trim(); }
  function lower(s){ return norm(s).toLowerCase(); }

  function getFilteredList(){
    const reg = norm(fr?.value);
    const bairro = lower(fb?.value);
    const logra  = lower(fl?.value);

    const base = Array.isArray(window.DEMANDAS) ? window.DEMANDAS : [];
    return base.filter(d => {
      const okReg = !reg || norm(d.regiao) === reg;
      const okBai = !bairro || lower(d.bairro).includes(bairro);
      const okLog = !logra  || lower(d.logradouro).includes(logra);
      return okReg && okBai && okLog;
    });
  }

  function rebuildMarkersFrom(list){
    try{
      if (typeof map === 'undefined' || !window.L) return;
      if (typeof clearAllMarkers !== 'function') return;
      if (typeof getMarkerStyle !== 'function') return;
      if (typeof buildPopupHtml !== 'function') return;
      if (typeof markersByItem === 'undefined') return;

      // limpa e recria s√≥ os filtrados
      clearAllMarkers();

      let count = 0;

      list.forEach(d => {
        if (typeof d?.lat !== 'number' || typeof d?.lng !== 'number') return;

        const { color, emoji } = getMarkerStyle(d.servico);

        const iconHtml = `
          <div class="demanda-marker-wrapper" style="background:${color};">
            <span>${emoji}</span>
          </div>
        `;

        const icon = L.divIcon({
          className:'',
          html:iconHtml,
          iconSize:[26,26],
          iconAnchor:[13,13]
        });

        const marker = L.marker([d.lat, d.lng], { icon }).addTo(map);
        marker.bindPopup(buildPopupHtml(d));

        // copiar endere√ßo (igual ao original)
        marker.on("popupopen", (ev) => {
          const el = ev.popup.getElement();
          const btn = el?.querySelector("button[data-copy]");
          if (btn) {
            btn.addEventListener("click", async () => {
              const text = btn.getAttribute("data-copy") || "";
              try {
                await navigator.clipboard.writeText(text);
                btn.textContent = "‚úÖ Copiado!";
                setTimeout(()=> btn.textContent = "üìã Copiar endere√ßo", 1200);
              } catch {
                alert("N√£o consegui copiar automaticamente. Copie manualmente:\n\n" + text);
              }
            }, { once:true });
          }
        });

        // ‚úÖ ao tocar no marcador: foca a demanda nos gr√°ficos
        marker.on("click", () => {
          try{
            if (typeof selectedItem !== 'undefined') selectedItem = d.item;
            if (pillSel) pillSel.textContent = `Selecionada: #${d.item} ‚Äî ${norm(d.logradouro) || '‚Äî'}`;
            if (window.__obratChartsSetFocus) window.__obratChartsSetFocus(d.item);
          }catch(e){}
        });

        markersByItem.set(d.item, marker);
        count++;
      });

      if (kpiGeo) kpiGeo.textContent = String(count);
    } catch(e){
      console.warn('rebuildMarkersFrom falhou:', e);
    }
  }

  function applyFiltersToMapAndList(){
    const list = getFilteredList();

    // atualiza lista (se existir)
    if (typeof renderTable === 'function') {
      renderTable(list);
    } else if (pillResumo) {
      pillResumo.textContent = `${list.length} demandas (filtradas)`;
    }

    // ‚úÖ atualiza marcadores
    rebuildMarkersFrom(list);

    // ‚úÖ atualiza gr√°ficos (sem limpar os filtros)
    if (window.__obratChartsUpdate) window.__obratChartsUpdate();
  }

  if(fr) fr.addEventListener('change', applyFiltersToMapAndList);
  if(fb) fb.addEventListener('input',  applyFiltersToMapAndList);
  if(fl) fl.addEventListener('input',  applyFiltersToMapAndList);

  window.addEventListener('load', () => {
    // garante que ao carregar, fica tudo sincronizado
    setTimeout(applyFiltersToMapAndList, 120);
  });
})();
</script>

</body>
</html>
